name: Merge PRs at the specified datetime based on labels.

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  merge:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;

            // 現在時刻を取得
            const now = new Date();

            // Open 状態の Pull Request を取得
            const prs = await github.paginate(
              github.rest.pulls.list,
              { owner, repo, state: "open" }
            );

            const allowedBaseBranches = ["master", "main"];
            for (const pr of prs) {
              // マージ対象ブランチかを判定
              if (!allowedBaseBranches.includes(pr.base.ref)) {
                console.log(`PR #${pr.number}: base is ${pr.base.ref}, skip`);
                continue;
              }

              // Draftは除外
              if (pr.draft) {
                console.log(`PR #${pr.number}: draft, skip`);
                continue;
              }

              // PRのラベルを取得
              const label = pr.labels.find(l => l.name === "merge-at");
              if (!label || !label.description) {
                continue;
              }

              // ラベルのDescriptionからマージ予定日時を取得する（"YYYY-MM-DD HH:mm" 形式）
              const match = label.description.match(
                /^(\d{4}-\d{2}-\d{2} \d{2}:\d{2})$/
              );
              if (!match) {
                console.log(`PR #${pr.number}: merge-at ラベルの形式が不正です`);
                continue;
              }

              // マージ予定日時はJSTを基準とする
              const mergeAt = new Date(
                match[1].replace(" ", "T") + ":00+09:00"
              );

              if (mergeAt > now) {
                console.log(`PR #${pr.number}: 指定した日時を経過していません`);
                continue;
              }

              console.log(`PR #${pr.number}: 指定した日時を経過しているためマージを実行します`);

              try {
                // マージ実行
                await github.rest.pulls.merge({
                  owner,
                  repo,
                  pull_number: pr.number,
                  merge_method: "squash",
                });
                console.log(`PR #${pr.number}: マージ成功`);
              } catch (e) {
                console.log(`PR #${pr.number}: マージ失敗 ${e.message}`);
              }
            
              try {
                // マージ後にラベルを外す（再実行防止）
                await github.rest.issues.removeLabel({
                  owner,
                  repo,
                  issue_number: pr.number,
                  name: "merge-at",
                });
                console.log(`PR #${pr.number}: ラベル削除成功`);
              } catch (e) {
                console.log(`PR #${pr.number}: ラベル削除失敗 ${e.message}`);
              }
            }
